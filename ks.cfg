# ESXi Kickstart - Instalação com rede, vSwitch e Memory Tiering

vmaccepteula

#clearpart --alldrives --overwritevmfs

#dryrun

# Instalação no disco NVMe específico (ou usa --firstdisk para testes)
#install --disk=t10.NVMe____CT1000T500SSD8__________________________ADA1A7490175A000 --overwritevmfs --novmfsondisk
install --firstdisk --overwritevmfs --novmfsondisk

keyboard Portuguese
rootpw VMware1!

# Configuração de rede estática com VLAN 10
network --bootproto=static --ip=192.168.10.101 --netmask=255.255.255.0 --gateway=192.168.10.1 --hostname=mn-a2-1.lab.net --device=vmnic1 --vlanid=10 --nameserver=192.168.10.1

%firstboot --interpreter=busybox

# Criação de vSwitch0 e uplinks
esxcli network vswitch standard add --vswitch-name=vSwitch0
esxcli network vswitch standard uplink add --uplink-name=vmnic1 --vswitch-name=vSwitch0
esxcli network vswitch standard uplink add --uplink-name=vmnic2 --vswitch-name=vSwitch0

# Portgroup de gestão com VLAN
esxcli network vswitch standard portgroup add --portgroup-name=Management --vswitch-name=vSwitch0
esxcli network vswitch standard portgroup set --portgroup-name=Management --vlan-id=10

# Desativa vmnic2 até automação mover para vDS
esxcli network nic down -n vmnic2

# Ativa SSH e ESXi Shell
vim-cmd hostsvc/enable_ssh
vim-cmd hostsvc/start_ssh
vim-cmd hostsvc/enable_esx_shell
vim-cmd hostsvc/start_esx_shell

# Suprime aviso do Shell
esxcli system settings advanced set -o /UserVars/SuppressShellWarning -i 1

# Desativa CEIP
esxcli system settings advanced set -o /UserVars/HostClientCEIPOptIn -i 2

# Ativa Memory Tiering e define percentagem NVMe
esxcli system settings kernel set -s MemoryTiering -v TRUE
esxcli system settings advanced set -o /Mem/TierNvmePct -i 400

# Workaround para VMs em hosts AMD Ryzen
echo 'monitor_control.disable_apichv = "TRUE"' >> /etc/vmware/config

# Reinicia sistema
reboot
